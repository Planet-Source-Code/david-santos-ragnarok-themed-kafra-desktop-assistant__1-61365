VERSION 5.00
Object = "{F9043C88-F6F2-101A-A3C9-08002B2F49FB}#1.2#0"; "COMDLG32.OCX"
Object = "{831FDD16-0C5C-11D2-A9FC-0000F8754DA1}#2.0#0"; "MSCOMCTL.OCX"
Begin VB.Form frmRegionMain 
   BackColor       =   &H8000000C&
   Caption         =   "Region Maker"
   ClientHeight    =   5310
   ClientLeft      =   165
   ClientTop       =   735
   ClientWidth     =   5985
   LinkTopic       =   "Form1"
   ScaleHeight     =   5310
   ScaleWidth      =   5985
   StartUpPosition =   3  'Windows Default
   Begin MSComctlLib.StatusBar StatusBar1 
      Align           =   2  'Align Bottom
      Height          =   255
      Left            =   0
      TabIndex        =   1
      Top             =   5055
      Width           =   5985
      _ExtentX        =   10557
      _ExtentY        =   450
      _Version        =   393216
      BeginProperty Panels {8E3867A5-8586-11D1-B16A-00C0F0283628} 
         NumPanels       =   2
         BeginProperty Panel1 {8E3867AB-8586-11D1-B16A-00C0F0283628} 
         EndProperty
         BeginProperty Panel2 {8E3867AB-8586-11D1-B16A-00C0F0283628} 
         EndProperty
      EndProperty
   End
   Begin MSComDlg.CommonDialog CommonDialog1 
      Left            =   5400
      Top             =   4440
      _ExtentX        =   847
      _ExtentY        =   847
      _Version        =   393216
   End
   Begin VB.PictureBox Picture1 
      AutoRedraw      =   -1  'True
      AutoSize        =   -1  'True
      BackColor       =   &H8000000C&
      BorderStyle     =   0  'None
      Height          =   4695
      Left            =   0
      ScaleHeight     =   4695
      ScaleWidth      =   5775
      TabIndex        =   0
      ToolTipText     =   "Preview only"
      Top             =   0
      Width           =   5775
   End
   Begin VB.Menu mnuFile 
      Caption         =   "&File"
      Begin VB.Menu mnuLoadPic 
         Caption         =   "&Load Picture"
         Shortcut        =   ^O
      End
      Begin VB.Menu mnuSave 
         Caption         =   "Save &Region"
         Enabled         =   0   'False
         Shortcut        =   ^S
      End
      Begin VB.Menu mnuBatch 
         Caption         =   "&Batch"
      End
      Begin VB.Menu mnuBlank 
         Caption         =   "-"
      End
      Begin VB.Menu mnuExit 
         Caption         =   "E&xit"
      End
   End
   Begin VB.Menu mnuRegion 
      Caption         =   "&Region"
      Begin VB.Menu mnuRgnTest 
         Caption         =   "&Test"
         Enabled         =   0   'False
         Shortcut        =   {F4}
      End
   End
   Begin VB.Menu mnuAbout 
      Caption         =   "&About"
   End
End
Attribute VB_Name = "frmRegionMain"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Option Explicit

Dim resFile As Long
Dim mOffset As Integer

Function BatchCreateRgn(BatchFolder As String, filename As String) As String
Dim sNewFile As String
    myDIBObj.ClearUp
    Picture1.Picture = LoadPicture(filename)
    myDIBObj.CreateFromPicture Picture1.Picture
    myRegion.Create myDIBObj, GetPixel(myDIBObj.hdc, 0, 0)
    sNewFile = Left(filename, Len(filename) - 3) & "rgn"
    sNewFile = Right(sNewFile, Len(sNewFile) - InStrRev(sNewFile, "\"))
    BatchCreateRgn = "IDR_" & mOffset & vbTab & vbTab & "RCDATA" & vbTab & "DISCARDABLE" & vbTab & """" & sNewFile & """"
    myRegion.Save BatchFolder & "\" & sNewFile
    myRegion.Destroy
End Function

Private Sub Form_Load()
    Set myDIBObj = New cDIBSection
    Set myRegion = New cDIBSectionRegion
End Sub

Private Sub Form_Unload(Cancel As Integer)
    myRegion.Destroy
    myDIBObj.ClearUp
    Set myDIBObj = Nothing
    Set myRegion = Nothing
End Sub

Private Sub mnuBatch_Click()
Dim a As String
Dim i As Integer
Dim resStr As String
Dim myBatchFolder As String
Dim GenerateRes As Boolean

Dim bmpStr As String
Dim rgnStr As String


    On Error GoTo errCOMDLG
    myDIBObj.ClearUp

    If MsgBox("The batch function creates .RGN files for all BMP files in a selected folder. Would you like RegionMaker to create a VB/C++ compatible Resource (.RES) File as well?", vbQuestion, "RegionMaker") = vbYes Then
        GenerateRes = True
    End If

    With CommonDialog1
        .CancelError = True
        .DialogTitle = "Select folder for batch processing"
        .ShowOpen
    End With

    resFile = FreeFile
    myBatchFolder = Replace(myBatchFolder, "\\", "\")
    If Right(myBatchFolder, 1) = "\" Then myBatchFolder = Left(myBatchFolder, Len(myBatchFolder) - 1)

    If GenerateRes = 1 Then Open myBatchFolder & "\data.rc" For Output As resFile

    mOffset = 101

    a = Dir(myBatchFolder & "\*.bmp")
    resStr = resStr & "//Generated by RegionMaker" & vbCrLf
    resStr = resStr & "#include ""data.h""" & vbCrLf & vbCrLf

    While a <> ""
        bmpStr = bmpStr & "IDB_" & mOffset & vbTab & vbTab & "BITMAP" & vbTab & "DISCARDABLE" & vbTab & """" & a & """" & vbCrLf
        rgnStr = rgnStr & BatchCreateRgn(myBatchFolder, myBatchFolder & "\" & a) & vbCrLf
        a = Dir
        i = i + 1
        mOffset = mOffset + 1
    Wend

    If GenerateRes = 1 Then
        Print #resFile, resStr & "//BITMAPS" & vbCrLf & bmpStr & vbCrLf & vbCrLf & "//REGIONS " & vbCrLf & rgnStr & vbCrLf
        Close resFile

        resFile = FreeFile
        Open myBatchFolder & "\data.h" For Output As resFile
        Print #resFile, "//Generated by RegionMaker" & vbCrLf
        Print #resFile, "//BITMAPS"
        For i = 101 To mOffset + 1
            Print #resFile, "#define IDB_" & i & vbTab & vbTab & vbTab & i
        Next
        Print #resFile, ""
        Print #resFile, "//REGIONS"
        For i = 101 To mOffset + 1
            Print #resFile, "#define IDR_" & i & vbTab & vbTab & vbTab & i
        Next
        Close resFile

        ChDir myBatchFolder
        Shell "rc.exe /r /fo data.res data.rc"

        MsgBox mOffset - 102 & " files were processed.", vbInformation, "RegionMaker"

    End If


errCOMDLG:
End Sub

Private Sub mnuExit_Click()
    Unload Me
End Sub

Private Sub mnuLoadPic_Click()
    On Error GoTo errCOMDLG
    myDIBObj.ClearUp

    With CommonDialog1
        .CancelError = True
        .Filter = "All images files|*.jpg;*.gif;*.bmp"
        .ShowOpen
        Picture1.Picture = LoadPicture(.filename)
        myDIBObj.CreateFromPicture Picture1.Picture
    End With

    Me.Show

    myRegion.Create myDIBObj, GetPixel(myDIBObj.hdc, 0, 0)

    Me.Width = myDIBObj.Width * 15 + 130
    Me.Height = myDIBObj.Height * 15 + 1150

    StatusBar1.Panels(1).Text = myDIBObj.Width & " x " & myDIBObj.Height
    'StatusBar1.Panels(1).Text = ""


    mnuRgnTest.Enabled = True
    mnuSave.Enabled = True

errCOMDLG:
End Sub

Private Sub mnuRgnTest_Click()
    frmRegionTest.Picture = Picture1.Picture
    frmRegionTest.Height = Picture1.Height
    frmRegionTest.Width = Picture1.Width
    
    frmProcessing.Show , Me
    myRegion.Destroy
    myRegion.Create myDIBObj, GetPixel(myDIBObj.hdc, 0, 0)
    myRegion.Applied(frmRegionTest.hWnd) = True
    Unload frmProcessing
    
    Me.Hide
    frmRegionTest.Show
End Sub

Private Sub mnuSave_Click()
Dim sNewFile As String
    myRegion.Create myDIBObj, GetPixel(myDIBObj.hdc, 0, 0)
    With CommonDialog1
        sNewFile = Left(.FileTitle, Len(.FileTitle) - 3) & "rgn"
        myRegion.Save App.Path & "\" & sNewFile
    End With
    MsgBox "Saved to """ & sNewFile & """", vbInformation + vbOKOnly, "Notice"
End Sub
